// Mikro B2B System - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  HEAD_ADMIN  // Süper admin - tüm yetkilere sahip, rol izinlerini yönetebilir
  ADMIN
  CUSTOMER
  SALES_REP   // Satış temsilcisi (sektör bazlı erişim)
  MANAGER     // Yönetici (tüm siparişleri görebilir)
  DIVERSEY    // Diversey distribütör kullanıcısı (sadece Diversey ürünlerini görür)
}

enum CustomerType {
  BAYI       // A Segmenti
  PERAKENDE  // B Segmenti
  VIP        // C Segmenti
  OZEL       // D Segmenti
}

enum PriceType {
  INVOICED  // Faturalı
  WHITE     // Beyaz
}

enum PriceVisibility {
  INVOICED_ONLY
  WHITE_ONLY
  BOTH
}

enum PriceMode {
  LIST
  EXCESS
}

enum CustomerRequestStatus {
  PENDING
  CONVERTED
  REJECTED
}

enum CustomerRequestItemStatus {
  PENDING
  CONVERTED
  REJECTED
}

enum OrderStatus {
  PENDING   // Bekliyor (admin onayı bekliyor)
  APPROVED  // Onaylandı ve Mikro'ya yazıldı
  REJECTED  // Reddedildi
}

enum OrderItemStatus {
  PENDING   // Bekliyor
  APPROVED  // Onaylandı
  REJECTED  // Reddedildi
}




enum QuoteStatus {
  PENDING_APPROVAL
  SENT_TO_MIKRO
  REJECTED
  CUSTOMER_ACCEPTED
  CUSTOMER_REJECTED
}

enum QuoteConversionSource {
  B2B
  MIKRO
}


enum QuoteHistoryAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  CONVERTED
}


enum QuoteItemStatus {
  OPEN
  CONVERTED
  CLOSED
}


enum QuotePriceSource {
  LAST_SALE   // Son satÄ±ÅŸ fiyatÄ±
  PRICE_LIST  // Mikro fiyat listesi
  MANUAL      // Manuel fiyat
}

enum CostCalculationMethod {
  LAST_ENTRY      // Son giriş fiyatı
  CURRENT_COST    // Güncel maliyet
  DYNAMIC         // Dinamik hesaplama (tarih ve fiyat farklarına göre)
}

enum LastPriceGuardType {
  COST
  PRICE_LIST
}

enum LastPriceCostBasis {
  CURRENT_COST
  LAST_ENTRY
}

enum TaskStatus {
  NEW
  TRIAGE
  IN_PROGRESS
  WAITING
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  NONE
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  BUG
  IMPROVEMENT
  FEATURE
  OPERATION
  PROCUREMENT
  REPORT
  DATA_SYNC
  ACCESS
  DESIGN_UX
  OTHER
}

enum TaskVisibility {
  PUBLIC
  INTERNAL
}

enum TaskLinkType {
  PRODUCT
  QUOTE
  ORDER
  CUSTOMER
  PAGE
  OTHER
}

enum TaskView {
  KANBAN
  LIST
}

enum VadeBalanceSource {
  MIKRO
  EXCEL
  MANUAL
}

enum VadeSyncStatus {
  SUCCESS
  FAILED
  PARTIAL
}

enum ReportSyncStatus {
  SUCCESS
  FAILED
}

enum EInvoiceMatchStatus {
  MATCHED
  PARTIAL
  NOT_FOUND
}

enum SupplierPriceListStatus {
  PENDING
  COMPLETED
  FAILED
}

// ==================== USERS ====================

model User {
  id            String        @id @default(uuid())
  email         String?       @unique // Optional: Cari kodu ile de login olunabilir
  password      String        // bcrypt hash
  name          String        // DEPRECATED: Use displayName or mikroName
  mikroName     String?       // Mikro'dan gelen orijinal isim (değişmez)
  displayName   String?       // Kullanıcının gösterilen ismi (düzenlenebilir)
  role          UserRole      @default(CUSTOMER)
  parentCustomerId String?
  parentCustomer   User?        @relation("CustomerHierarchy", fields: [parentCustomerId], references: [id])
  priceVisibility  PriceVisibility @default(INVOICED_ONLY)


  // Müşteri bilgileri (sadece CUSTOMER role için)
  customerType        CustomerType?
  mikroCariCode       String?       @unique // Mikro ERP'deki cari kodu
  vatDisplayPreference String       @default("WITHOUT_VAT") // "WITH_VAT" | "WITHOUT_VAT"
  // Optional price list overrides (use settings when null)
  invoicedPriceListNo Int?
  whitePriceListNo    Int?
  lastPriceGuardInvoicedListNo Int?
  lastPriceGuardWhiteListNo    Int?
  useLastPrices       Boolean          @default(false)
  lastPriceGuardType  LastPriceGuardType @default(COST)
  lastPriceCostBasis  LastPriceCostBasis @default(CURRENT_COST)
  lastPriceMinCostPercent Float         @default(10)
  quoteLastSalesCount Int          @default(1)
  quoteWhatsappTemplate String?
  quoteResponsibleCode String?
  quoteColumnWidths    Json?
  quotePoolSort        String?
  quotePoolPriceListNo Int?
  quotePoolColorRules  Json?
  taskColorRules       Json?
  taskDefaultView       TaskView    @default(KANBAN)

  // Mikro'dan senkronize edilen cari bilgileri
  city                String?       // Şehir
  district            String?       // İlçe
  phone               String?       // Telefon
  isLocked            Boolean       @default(false) // Cari kilitli mi
  groupCode           String?       // Grup kodu
  sectorCode          String?       // Sektör kodu
  paymentTerm         Int?          // Vade günü (deprecated - use payment plan)
  paymentPlanNo       Int?
  paymentPlanCode     String?
  paymentPlanName     String?
  hasEInvoice         Boolean       @default(false) // E-fatura var mı
  balance             Float         @default(0) // Güncel bakiye (TL)
  balanceUpdatedAt    DateTime?     // Bakiye güncellenme tarihi

  // Sales Rep için atanan sektör kodları (JSON array)
  // Örnek: ["İNTERNET", "HENDEK", "HUKUKİ"]
  assignedSectorCodes String[]      @default([])

  active        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  subUsers          User[]       @relation("CustomerHierarchy")
  priceAgreements   CustomerPriceAgreement[]
  createdRequests   CustomerRequest[] @relation("CustomerRequestCreator")
  receivedRequests  CustomerRequest[] @relation("CustomerRequestParent")
  convertedRequests CustomerRequest[] @relation("CustomerRequestConverter")
  requestedOrders   Order[]      @relation("OrderRequestedBy")
  orders        Order[]
  cart          Cart?
  searchPreferences UserSearchPreferences?
  quotes             Quote[]       @relation("QuoteCustomer")
  createdQuotes      Quote[]       @relation("QuoteCreator")
  adminQuotes        Quote[]       @relation("QuoteAdmin")
  contacts           CustomerContact[]
  createdTasks       Task[]        @relation("TaskCreator")
  assignedTasks      Task[]        @relation("TaskAssignee")
  customerTasks      Task[]        @relation("TaskCustomer")
  taskTemplates      TaskTemplate[] @relation("TaskTemplateCreator")
  taskComments       TaskComment[] @relation("TaskCommentAuthor")
  taskAttachments    TaskAttachment[] @relation("TaskAttachmentUploader")
  taskStatusChanges  TaskStatusHistory[] @relation("TaskStatusChanger")
  notifications      Notification[]
  vadeBalance        VadeBalance?
  vadeNotes          VadeNote[]       @relation("VadeNoteCustomer")
  vadeNotesAuthored  VadeNote[]       @relation("VadeNoteAuthor")
  vadeClassification VadeClassification?
  vadeClassificationsCreated VadeClassification[] @relation("VadeClassificationCreator")
  vadeClassificationsUpdated VadeClassification[] @relation("VadeClassificationUpdater")
  vadeAssignments    VadeAssignment[] @relation("VadeAssignmentStaff")
  vadeAssignmentsAsCustomer VadeAssignment[] @relation("VadeAssignmentCustomer")
  vadeAssignmentsCreated VadeAssignment[] @relation("VadeAssignmentCreator")
  eInvoiceDocuments  EInvoiceDocument[] @relation("EInvoiceCustomer")
  eInvoiceUploads    EInvoiceDocument[] @relation("EInvoiceUploader")
  supplierPriceListUploads SupplierPriceListUpload[] @relation("SupplierPriceListUploader")
  priceListRules     CustomerPriceListRule[]

  quotesUpdated      Quote[]       @relation("QuoteUpdater")
  quoteHistories     QuoteHistory[] @relation("QuoteHistoryActor")
  @@index([email])
  @@index([role])
  @@index([mikroCariCode])
  @@index([sectorCode])
}

// ==================== USER PREFERENCES ====================

// Kullanıcıların stok ve cari arama sayfaları için kolon tercihleri
model UserSearchPreferences {
  id                    String    @id @default(uuid())

  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stok arama için seçili kolonlar (JSON array)
  // Örnek: ["sto_kod", "sto_isim", "KDV Oranı", "Güncel Maliyet + Kdv.", ...]
  stockColumns          String[]  @default([])

  // Cari arama için seçili kolonlar (JSON array)
  // Örnek: ["cari_kod", "cari_unvan1", "IL", "ILCE", ...]
  customerColumns       String[]  @default([])

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

// ==================== ROLE PERMISSIONS ====================

// HEAD_ADMIN tarafından yönetilen rol bazlı izinler
model RolePermission {
  id          String    @id @default(uuid())

  role        UserRole  // Hangi rol için geçerli
  permission  String    // İzin kodu (örn: "dashboard:orders", "dashboard:ekstre", "reports:margin")
  enabled     Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([role, permission])
  @@index([role])
  @@index([enabled])
}

// ==================== SETTINGS ====================

model Settings {
  id                        String                  @id @default(uuid())

  // Fazla stok hesaplama ayarları
  calculationPeriodMonths   Int                     @default(3)  // 1, 3, veya 6 ay (DEPRECATED - use calculationPeriodDays)
  calculationPeriodDays     Int                     @default(90) // Son X günlük satış ortalaması
  includedWarehouses        String[]                // ["DEPO1", "MERKEZ"]
  minimumExcessThreshold    Int                     @default(10) // Min fazla stok eşiği

  // Maliyet hesaplama yöntemi
  costCalculationMethod     CostCalculationMethod   @default(LAST_ENTRY)

  // Dinamik maliyet hesaplama parametreleri (JSON)
  // Örnek: { "dayThreshold": 30, "priceWeightNew": 0.7, "priceWeightOld": 0.3 }
  dynamicCostParams         Json?

  // KDV hesaplama formülü (beyaz fiyat için)
  // Varsayılan: cost * (1 + vat/2)
  whiteVatFormula           String                  @default("cost * (1 + vat/2)")

  // Customer segment -> price list mapping (JSON)
  // Example: {"BAYI":{"invoiced":6,"white":1},"PERAKENDE":{"invoiced":6,"white":1}}
  customerPriceLists        Json?

  // Son senkronizasyon
  lastSyncAt                DateTime?
  lastVadeSyncAt            DateTime?
  marginReportEmailEnabled  Boolean                 @default(false)
  marginReportEmailRecipients String[]              @default([])
  marginReportEmailSubject  String                  @default("Kar Marji Raporu")
  marginReportEmailColumns String[]              @default([])

  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
}

// ==================== VADE TRACKING ====================

model VadeBalance {
  id                String             @id @default(uuid())
  userId            String             @unique
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  pastDueBalance    Float              @default(0)
  pastDueDate       DateTime?
  notDueBalance     Float              @default(0)
  notDueDate        DateTime?
  totalBalance      Float              @default(0)
  valor             Int                @default(0)
  paymentTermLabel  String?
  referenceDate     DateTime?
  source            VadeBalanceSource  @default(MIKRO)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([pastDueDate])
  @@index([notDueDate])
}

model VadeNote {
  id                String   @id @default(uuid())
  customerId        String
  customer          User     @relation("VadeNoteCustomer", fields: [customerId], references: [id], onDelete: Cascade)
  authorId          String?
  author            User?    @relation("VadeNoteAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  noteContent       String
  promiseDate       DateTime?
  tags              String[] @default([])
  reminderDate      DateTime?
  reminderNote      String?
  reminderCompleted Boolean  @default(false)
  reminderSentAt    DateTime?
  balanceAtTime     Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([customerId])
  @@index([authorId])
  @@index([reminderDate])
  @@index([reminderCompleted])
}

model VadeClassification {
  id                   String   @id @default(uuid())
  customerId           String   @unique
  customer             User     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  classification       String
  customClassification String?
  riskScore            Int?
  createdById          String?
  createdBy            User?    @relation("VadeClassificationCreator", fields: [createdById], references: [id], onDelete: SetNull)
  updatedById          String?
  updatedBy            User?    @relation("VadeClassificationUpdater", fields: [updatedById], references: [id], onDelete: SetNull)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([customerId])
}

model VadeAssignment {
  id           String   @id @default(uuid())
  staffId      String
  staff        User     @relation("VadeAssignmentStaff", fields: [staffId], references: [id], onDelete: Cascade)
  customerId   String
  customer     User     @relation("VadeAssignmentCustomer", fields: [customerId], references: [id], onDelete: Cascade)
  assignedById String?
  assignedBy   User?    @relation("VadeAssignmentCreator", fields: [assignedById], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([staffId, customerId])
  @@index([staffId])
  @@index([customerId])
}

model VadeSyncLog {
  id             String          @id @default(uuid())
  source         VadeBalanceSource
  status         VadeSyncStatus
  recordsTotal   Int             @default(0)
  recordsUpdated Int             @default(0)
  recordsSkipped Int             @default(0)
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  errorMessage   String?
  details        Json?

  @@index([source])
  @@index([status])
  @@index([startedAt])
}

// ==================== E-INVOICE DOCUMENTS ====================

model EInvoiceDocument {
  id            String              @id @default(uuid())
  invoiceNo     String              @unique
  evrakSeri     String?
  evrakSira     Int?
  eInvoiceUuid  String?
  customerCode  String?
  customerName  String?
  customerId    String?
  customer      User?               @relation("EInvoiceCustomer", fields: [customerId], references: [id], onDelete: SetNull)
  issueDate     DateTime?
  sentAt        DateTime?
  subtotalAmount Float?
  totalAmount    Float?
  currency       String             @default("TRY")

  fileName      String
  originalName  String
  mimeType      String
  size          Int
  storagePath   String

  uploadedById  String
  uploadedBy    User                @relation("EInvoiceUploader", fields: [uploadedById], references: [id], onDelete: Restrict)

  matchStatus   EInvoiceMatchStatus @default(MATCHED)
  matchError    String?

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([customerId])
  @@index([customerCode])
  @@index([issueDate])
  @@index([sentAt])
  @@index([matchStatus])
}

// ==================== CATEGORIES ====================

model Category {
  id              String                @id @default(uuid())
  mikroCode       String                @unique
  name            String

  active          Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  products        Product[]
  priceRules      CategoryPriceRule[]
  priceListRules  CustomerPriceListRule[]
}

// ==================== PRODUCTS ====================

model Product {
  id                      String    @id @default(uuid())
  mikroCode               String    @unique
  name                    String
  foreignName             String?   // Tedarikci urun kodu (Mikro: sto_yabanci_isim)
  brandCode               String?   // Mikro marka kodu (sto_marka_kodu)
  unit                    String    @default("ADET") // Birim
  unit2                   String?   // 2. Birim
  unit2Factor             Float?    // 2. Birim Katsayısı

  categoryId              String
  category                Category  @relation(fields: [categoryId], references: [id])

  // Maliyet bilgileri (Mikro'dan sync)
  lastEntryPrice          Float?    // Son giriş fiyatı
  lastEntryDate           DateTime? // Son giriş tarihi
  currentCost             Float?    // Güncel maliyet (tanımlı)
  currentCostDate         DateTime? // Güncel maliyet tarihi
  vatRate                 Float     @default(0.18) // KDV oranı (0.18 = %18)

  // Hesaplanan maliyet (dinamik veya seçilen method'a göre)
  calculatedCost          Float?

  // Stok bilgileri (JSON - depo bazlı)
  // Örnek: {"DEPO1": 100, "DEPO2": 50, "MERKEZ": 75}
  warehouseStocks         Json      @default("{}")

  // Satış geçmişi (JSON - günlük)
  // Örnek: {"2024-01-15": 5, "2024-01-16": 3, "2024-01-17": 8}
  salesHistory            Json      @default("{}")

  // Bekleyen siparişler
  pendingCustomerOrders   Int       @default(0)
  pendingPurchaseOrders   Int       @default(0)
  pendingCustomerOrdersByWarehouse Json @default("{}")

  // Hesaplanan fazla stok (toplam)
  excessStock             Int       @default(0)

  // Depo bazlı fazla stoklar (JSON)
  // Örnek: {"DEPO1": 20, "DEPO2": 10, "MERKEZ": 0}
  warehouseExcessStocks   Json      @default("{}")

  // Hesaplanan fiyatlar (JSON)
  // {
  //   "BAYI": { "INVOICED": 115, "WHITE": 110 },
  //   "PERAKENDE": { "INVOICED": 125, "WHITE": 110 },
  //   "VIP": { "INVOICED": 110, "WHITE": 110 },
  //   "OZEL": { "INVOICED": 120, "WHITE": 110 }
  // }
  prices                  Json      @default("{}")

  // Ürün resmi
  imageUrl                String?
  imageChecksum           String?
  imageSyncStatus         String?
  imageSyncErrorType      String?
  imageSyncErrorMessage   String?
  imageSyncUpdatedAt      DateTime?

  active                  Boolean   @default(true)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  cartItems               CartItem[]
  orderItems              OrderItem[]
  quoteItems              QuoteItem[]
  priceOverrides          ProductPriceOverride[]
  priceAgreements         CustomerPriceAgreement[]
  customerRequestItems    CustomerRequestItem[]
  supplierPriceListMatches SupplierPriceListMatch[]

  @@index([mikroCode])
  @@index([foreignName])
  @@index([excessStock])
  @@index([categoryId])
  @@index([imageSyncStatus])
  @@index([imageSyncErrorType])
  @@index([imageSyncUpdatedAt])
}

// ==================== SUPPLIERS & PRICE LISTS ====================

model Supplier {
  id                String    @id @default(uuid())
  name              String    @unique
  active            Boolean   @default(true)
  discount1         Float?
  discount2         Float?
  discount3         Float?
  discount4         Float?
  discount5         Float?
  priceIsNet        Boolean   @default(false)
  priceIncludesVat  Boolean   @default(false)
  priceByColor      Boolean   @default(false)
  defaultVatRate    Float?
  excelSheetName    String?
  excelHeaderRow    Int?
  excelCodeHeader   String?
  excelNameHeader   String?
  excelPriceHeader  String?
  pdfPriceIndex     Int?
  pdfCodePattern    String?
  discountRules     Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  priceListUploads  SupplierPriceListUpload[]
}

model SupplierPriceListUpload {
  id              String    @id @default(uuid())
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  uploadedById    String
  uploadedBy      User      @relation("SupplierPriceListUploader", fields: [uploadedById], references: [id], onDelete: Restrict)
  status          SupplierPriceListStatus @default(PENDING)
  fileCount       Int       @default(0)
  totalItems      Int       @default(0)
  matchedItems    Int       @default(0)
  unmatchedItems  Int       @default(0)
  multiMatchItems Int       @default(0)
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  errorMessage    String?
  details         Json?

  files           SupplierPriceListFile[]
  items           SupplierPriceListItem[]

  @@index([supplierId])
  @@index([uploadedById])
  @@index([createdAt])
}

model SupplierPriceListFile {
  id           String   @id @default(uuid())
  uploadId     String
  upload       SupplierPriceListUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  fileName     String
  originalName String
  mimeType     String
  size         Int
  storagePath  String
  createdAt    DateTime @default(now())

  @@index([uploadId])
}

model SupplierPriceListItem {
  id                 String   @id @default(uuid())
  uploadId           String
  upload             SupplierPriceListUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  supplierCode       String
  supplierName       String?
  sourcePrice        Float?
  netPrice           Float?
  priceCurrency      String?
  priceIncludesVat   Boolean  @default(false)
  rawLine            String?
  matchCount         Int      @default(0)
  matchedProductIds  String[] @default([])
  createdAt          DateTime @default(now())

  matches            SupplierPriceListMatch[]

  @@index([uploadId])
  @@index([supplierCode])
}

model SupplierPriceListMatch {
  id             String   @id @default(uuid())
  itemId         String
  item           SupplierPriceListItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  productCode    String
  productName    String
  currentCost    Float?
  sourcePrice    Float?
  vatRate        Float?
  netPrice       Float?
  costDifference Float?
  createdAt      DateTime @default(now())

  @@index([itemId])
  @@index([productId])
}

// ==================== PRICE RULES ====================

// Kategori bazlı kar marjları
model CategoryPriceRule {
  id              String        @id @default(uuid())

  categoryId      String
  category        Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  customerType    CustomerType
  profitMargin    Float         // 0.15 = %15 kar marjı

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([categoryId, customerType])
}

// Ürün bazlı özel kar marjı (override)
model ProductPriceOverride {
  id              String        @id @default(uuid())

  productId       String
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  customerType    CustomerType
  profitMargin    Float         // Kategori marjını override eder

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([productId, customerType])
}

// Musteri bazli fiyat listesi kurallari (marka/kategori)
model CustomerPriceListRule {
  id                   String    @id @default(uuid())
  customerId           String
  customer             User      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  brandCode            String?
  categoryId           String?
  category             Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  invoicedPriceListNo  Int
  whitePriceListNo     Int
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@unique([customerId, brandCode, categoryId])
  @@index([customerId])
  @@index([brandCode])
  @@index([categoryId])
}

// ==================== CART ====================

model Cart {
  id              String        @id @default(uuid())

  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  items           CartItem[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model CartItem {
  id              String      @id @default(uuid())

  cartId          String
  cart            Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId       String
  product         Product     @relation(fields: [productId], references: [id])

  quantity        Int
  priceType       PriceType   // INVOICED veya WHITE
  priceMode       PriceMode   @default(LIST)
  unitPrice       Float       // O andaki fiyat (snapshot)
  lineNote          String?
  approvedQuantity  Int?
  responsibilityCenter String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([cartId])
}

// ==================== ORDERS ====================

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique  // "ORD-2024-00001"

  userId          String
  user            User          @relation(fields: [userId], references: [id])

  requestedById   String?
  requestedBy     User?         @relation("OrderRequestedBy", fields: [requestedById], references: [id])

  status          OrderStatus   @default(PENDING)

  // Sipariş detayları
  items           OrderItem[]
  totalAmount     Float

  // Mikro'ya yazılan sipariş ID'leri
  // [invoiced_siparis_id, white_siparis_id] veya sadece [invoiced] veya [white]
  mikroOrderIds   String[]      @default([])

  customerRequest CustomerRequest? @relation("CustomerRequestOrder")

  sourceQuoteId   String?
  sourceQuote     Quote?        @relation("QuoteOrders", fields: [sourceQuoteId], references: [id])

  customerOrderNumber String?
  deliveryLocation String?

  // Admin notu
  adminNote       String?

  createdAt       DateTime      @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@index([orderNumber])
}

model OrderItem {
  id              String            @id @default(uuid())

  orderId         String
  order           Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       String?           // Optional - ürün silinirse null olabilir
  product         Product?          @relation(fields: [productId], references: [id])

  // Snapshot (sipariş anındaki bilgiler)
  productName     String
  mikroCode       String
  quantity        Int
  priceType       PriceType
  unitPrice       Float
  totalPrice      Float
  lineNote          String?
  approvedQuantity  Int?
  responsibilityCenter String?

  // Item-level approval (kısmi onay için)
  status          OrderItemStatus   @default(PENDING)
  rejectionReason String?           // Reddedilme sebebi

  // Mikro'ya yazılan sipariş ID (item bazında)
  mikroOrderId    String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now()) @updatedAt

  @@index([orderId])
  @@index([status])
}

// ==================== CUSTOMER AGREEMENTS ====================

model CustomerPriceAgreement {
  id           String   @id @default(uuid())

  customerId   String
  customer     User     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  productId    String
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  priceInvoiced Float
  priceWhite   Float?
  customerProductCode String?
  minQuantity  Int      @default(1)
  validFrom    DateTime
  validTo      DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([customerId, productId])
  @@index([customerId])
  @@index([productId])
  @@index([validFrom])
  @@index([validTo])
}

// ==================== CUSTOMER REQUESTS ====================

model CustomerRequest {
  id              String                 @id @default(uuid())

  parentCustomerId String
  parentCustomer  User                   @relation("CustomerRequestParent", fields: [parentCustomerId], references: [id])

  requestedById   String
  requestedBy     User                   @relation("CustomerRequestCreator", fields: [requestedById], references: [id])

  convertedById   String?
  convertedBy     User?                  @relation("CustomerRequestConverter", fields: [convertedById], references: [id])

  status          CustomerRequestStatus  @default(PENDING)
  note            String?
  orderId         String?                @unique
  order           Order?                 @relation("CustomerRequestOrder", fields: [orderId], references: [id])

  items           CustomerRequestItem[]

  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  convertedAt     DateTime?

  @@index([parentCustomerId])
  @@index([requestedById])
  @@index([status])
  @@index([orderId])
}

model CustomerRequestItem {
  id                String      @id @default(uuid())

  requestId         String
  request           CustomerRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  productId         String
  product           Product     @relation(fields: [productId], references: [id])

  quantity          Int
  status            CustomerRequestItemStatus @default(PENDING)
  priceMode         PriceMode   @default(LIST)
  lineNote          String?
  approvedQuantity  Int?
  responsibilityCenter String?
  selectedPriceType PriceType?
  selectedUnitPrice Float?
  selectedTotalPrice Float?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([requestId])
  @@index([productId])
}

// ==================== QUOTES ====================

model Quote {
  id                String        @id @default(uuid())
  quoteNumber       String        @unique // "TEK-2025-00001"

  status            QuoteStatus   @default(PENDING_APPROVAL)

  customerId        String
  customer          User          @relation("QuoteCustomer", fields: [customerId], references: [id])

  createdById       String
  createdBy         User          @relation("QuoteCreator", fields: [createdById], references: [id])

  adminUserId       String?
  updatedById       String?
  updatedBy         User?         @relation("QuoteUpdater", fields: [updatedById], references: [id])

  convertedAt       DateTime?
  convertedSource   QuoteConversionSource?

  orders            Order[]       @relation("QuoteOrders")
  histories         QuoteHistory[]
  adminUser         User?         @relation("QuoteAdmin", fields: [adminUserId], references: [id])

  items             QuoteItem[]
  note              String?
  documentNo        String?
  responsibleCode   String?
  contactId         String?
  contact           CustomerContact? @relation("QuoteContact", fields: [contactId], references: [id])
  contactName       String?
  contactPhone      String?
  contactEmail      String?
  validityDate      DateTime
  vatZeroed         Boolean       @default(false)
  totalAmount       Float
  totalVat          Float
  grandTotal        Float

  mikroNumber       String?
  mikroGuid         String?
  mikroUpdatedAt    DateTime?

  adminNote         String?
  adminActionAt     DateTime?
  customerRespondedAt DateTime?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([customerId])
  @@index([createdById])
  @@index([status])
  @@index([mikroNumber])
}

model QuoteItem {
  id                String            @id @default(uuid())

  quoteId           String
  quote             Quote             @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  productId         String?
  product           Product?          @relation(fields: [productId], references: [id])

  productCode       String
  productName       String
  unit              String           @default("ADET")
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  lineOrder       Int              @default(0)

  priceSource       QuotePriceSource
  priceListNo       Int?
  priceType         PriceType         @default(INVOICED)

  vatRate           Float
  vatZeroed         Boolean           @default(false)

  isManualLine      Boolean           @default(false)
  isBlocked         Boolean           @default(false)
  blockedReason     String?

  status            QuoteItemStatus   @default(OPEN)
  statusUpdatedAt   DateTime          @default(now())
  closedReason      String?
  closedAt          DateTime?
  convertedAt       DateTime?


  sourceSaleDate    DateTime?
  sourceSalePrice   Float?
  sourceSaleQuantity Float?
  sourceSaleVatZeroed Boolean?

  lineDescription   String?
  manualImageUrl    String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([quoteId])
  @@index([productId])
  @@index([productCode])
  @@index([priceSource])
  @@index([status])
  @@index([statusUpdatedAt])
}

model QuoteHistory {
  id        String              @id @default(uuid())
  quoteId   String
  quote     Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  action    QuoteHistoryAction
  summary   String?
  payload   Json?
  actorId   String?
  actor     User?               @relation("QuoteHistoryActor", fields: [actorId], references: [id])
  createdAt DateTime            @default(now())

  @@index([quoteId])
  @@index([actorId])
}

model CustomerContact {
  id         String   @id @default(uuid())
  customerId String
  customer   User     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name       String
  phone      String?
  email      String?

  quotes      Quote[] @relation("QuoteContact")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([customerId])
}

// ==================== SYNC LOGS ====================

model SyncLog {
  id                    String      @id @default(uuid())

  syncType              String      // "AUTO" | "MANUAL"
  status                String      // "RUNNING" | "SUCCESS" | "FAILED" | "PARTIAL"

  categoriesCount       Int         @default(0)
  productsCount         Int         @default(0)
  imagesDownloaded      Int         @default(0)
  imagesSkipped         Int         @default(0)
  imagesFailed          Int         @default(0)

  errorMessage          String?
  details               Json?       // Detaylı log bilgileri

  // Uyarılar (JSON array)
  // Örnek: [{ "type": "IMAGE_TOO_LARGE", "productCode": "B999", "message": "Resim çok büyük (25 MB)", "size": 26214400 }]
  warnings              Json?

  startedAt             DateTime    @default(now())
  completedAt           DateTime?

  @@index([syncType])
  @@index([status])
}

// ==================== MARGIN COMPLIANCE REPORT CACHE ====================

model MarginComplianceReportDay {
  id           String           @id @default(uuid())
  reportDate   DateTime         @unique
  status       ReportSyncStatus @default(SUCCESS)
  rowCount     Int              @default(0)
  errorMessage String?
  syncedAt     DateTime         @default(now())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([reportDate])
  @@index([status])
}

model MarginComplianceReportRow {
  id           String   @id @default(uuid())
  reportDate   DateTime
  sectorCode   String?
  groupCode    String?
  avgMargin    Float?
  totalRevenue Float?
  totalProfit  Float?
  data         Json
  createdAt    DateTime @default(now())

  @@index([reportDate])
  @@index([sectorCode])
  @@index([groupCode])
  @@index([avgMargin])
}


// ==================== CAMPAIGNS ====================

enum CampaignType {
  PERCENTAGE      // Yüzde indirim
  FIXED_AMOUNT    // Sabit tutar indirim
  BUY_X_GET_Y     // X al Y öde
}

model Campaign {
  id                    String        @id @default(uuid())
  name                  String
  description           String?

  type                  CampaignType  @default(PERCENTAGE)
  discountValue         Float         // Percentage: 0.15 = %15, Fixed: 50 = 50 TL

  minOrderAmount        Float?        // Minimum sipariş tutarı
  maxDiscountAmount     Float?        // Maksimum indirim tutarı

  startDate             DateTime
  endDate               DateTime
  active                Boolean       @default(true)

  // Targeting
  customerTypes         String[]      @default([]) // ["BAYI", "PERAKENDE"]
  categoryIds           String[]      @default([]) // Specific categories
  productIds            String[]      @default([]) // Specific products

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([active])
  @@index([startDate, endDate])
}

// ==================== ORDER TRACKING ====================

// Sipariş takip modülü ayarları
model OrderTrackingSettings {
  id                    String    @id @default(uuid())

  // Sync ayarları
  syncEnabled           Boolean   @default(true)
  syncSchedule          String    @default("0 8 * * 2,5") // DEPRECATED - use customerSyncSchedule

  // Müşteri email ayarları
  customerSyncSchedule  String    @default("0 8 * * 2,5") // Salı + Cuma, 08:00 (cron format)
  customerEmailEnabled  Boolean   @default(true)
  customerEmailSubject  String    @default("Bekleyen Siparişleriniz")

  // Tedarikçi email ayarları
  supplierSyncSchedule  String    @default("0 8 * * 2,5") // Salı + Cuma, 08:00 (cron format)
  supplierEmailEnabled  Boolean   @default(true)
  supplierEmailSubject  String    @default("Bekleyen Tedarikçi Siparişleri")

  // Email template
  emailEnabled          Boolean   @default(true) // DEPRECATED - use customerEmailEnabled
  emailSubject          String    @default("Bekleyen Siparişleriniz") // DEPRECATED - use customerEmailSubject
  emailTemplate         String    @default("default") // "default" veya custom HTML template

  // Son sync bilgisi
  lastSyncAt            DateTime?
  lastEmailSentAt       DateTime? // DEPRECATED - use lastCustomerEmailSentAt
  lastCustomerEmailSentAt DateTime?
  lastSupplierEmailSentAt DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// Mikro'dan çekilen bekleyen siparişler (cache)
model PendingMikroOrder {
  id                    String    @id @default(uuid())

  // Sipariş bilgileri
  mikroOrderNumber      String    @unique // "HENDEK-8162" - Her sipariş tek bir kayıt olmalı
  orderSeries           String    // "HENDEK"
  orderSequence         Int       // 8162

  // Müşteri bilgileri
  customerCode          String    // "120.05.125"
  customerName          String    // "ÇAMSAN ENTEGRE..."
  customerEmail         String?   // Mikro'dan gelen email (cari_EMail)
  sectorCode            String?   // Sektör kodu (örn: "satıcı" = tedarikçi)

  // Tarihler
  orderDate             DateTime
  deliveryDate          DateTime?

  // Sipariş detayları (JSON array)
  // [{ productCode, productName, unit, quantity, deliveredQty, remainingQty, unitPrice, lineTotal, vat }]
  items                 Json

  // Toplamlar
  itemCount             Int       // Kalem sayısı
  totalAmount           Float     // Ara toplam (KDV hariç)
  totalVAT              Float     // Toplam KDV
  grandTotal            Float     // Genel toplam (KDV dahil)

  // Sync bilgisi
  syncedAt              DateTime  @default(now())

  // Email gönderildi mi?
  emailSent             Boolean   @default(false)
  emailSentAt           DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([customerCode])
  @@index([mikroOrderNumber])
  @@index([syncedAt])
  @@index([emailSent])
  @@index([sectorCode])
}

// Email gönderim logları
model EmailLog {
  id                    String    @id @default(uuid())

  // Alıcı bilgileri
  recipientEmail        String
  recipientName         String?
  customerCode          String?

  // Email bilgileri
  subject               String
  ordersCount           Int       // Kaç sipariş gönderildi
  totalAmount           Float     // Toplam tutar

  // Gönderim durumu
  success               Boolean   @default(false)
  errorMessage          String?

  // Brevo bilgileri
  brevoMessageId        String?

  sentAt                DateTime  @default(now())

  @@index([recipientEmail])
  @@index([customerCode])
  @@index([sentAt])
  @@index([success])
}

// ==================== PRICE HISTORY ====================

// Fiyat değişiklik geçmişi (Mikro FIYAT_DEGISIM tablosundan sync)
model PriceChange {
  id                    String    @id @default(uuid())

  // Ürün bilgileri
  productCode           String @map("product_code")
  productName           String @map("product_name")

  // Fiyat değişikliği
  oldPrice              Decimal   @db.Decimal(18, 4) @map("old_price")
  newPrice              Decimal   @db.Decimal(18, 4) @map("new_price")
  changeAmount          Decimal   @db.Decimal(18, 4) @map("change_amount")
  changePercent         Decimal   @db.Decimal(18, 4) @map("change_percent")
  changedAt             DateTime @map("change_date")

  // Güncel maliyet ve fiyat listeleri (10 adet)
  currentCost           Decimal   @db.Decimal(18, 4) @map("current_cost")
  priceList1            Decimal?  @db.Decimal(18, 4) @map("price_list_1")
  priceList2            Decimal?  @db.Decimal(18, 4) @map("price_list_2")
  priceList3            Decimal?  @db.Decimal(18, 4) @map("price_list_3")
  priceList4            Decimal?  @db.Decimal(18, 4) @map("price_list_4")
  priceList5            Decimal?  @db.Decimal(18, 4) @map("price_list_5")
  priceList6            Decimal?  @db.Decimal(18, 4) @map("price_list_6")
  priceList7            Decimal?  @db.Decimal(18, 4) @map("price_list_7")
  priceList8            Decimal?  @db.Decimal(18, 4) @map("price_list_8")
  priceList9            Decimal?  @db.Decimal(18, 4) @map("price_list_9")
  priceList10           Decimal?  @db.Decimal(18, 4) @map("price_list_10")

  // Marj oranları (10 adet) - maliyet üzerinden hesaplanan kar marjı yüzdeleri
  marginList1           Decimal?  @db.Decimal(18, 4) @map("margin_list_1")
  marginList2           Decimal?  @db.Decimal(18, 4) @map("margin_list_2")
  marginList3           Decimal?  @db.Decimal(18, 4) @map("margin_list_3")
  marginList4           Decimal?  @db.Decimal(18, 4) @map("margin_list_4")
  marginList5           Decimal?  @db.Decimal(18, 4) @map("margin_list_5")
  marginList6           Decimal?  @db.Decimal(18, 4) @map("margin_list_6")
  marginList7           Decimal?  @db.Decimal(18, 4) @map("margin_list_7")
  marginList8           Decimal?  @db.Decimal(18, 4) @map("margin_list_8")
  marginList9           Decimal?  @db.Decimal(18, 4) @map("margin_list_9")
  marginList10          Decimal?  @db.Decimal(18, 4) @map("margin_list_10")

  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([productCode])
  @@index([changedAt])
  @@index([changePercent])
  @@map("price_changes")
}

// Ürün fiyat istatistikleri (özet bilgiler)
model ProductPriceStat {
  id                    String    @id @default(uuid())

  productCode           String    @unique @map("product_code")
  productName           String @map("product_name")

  // Son değişiklik
  lastChangeDate        DateTime @map("last_change_date")

  // Toplam değişiklik sayısı
  totalChanges          Int       @default(0) @map("total_changes")

  // Güncel değerler
  currentCost           Decimal   @db.Decimal(18, 4) @map("current_cost")
  currentPriceList1     Decimal?  @db.Decimal(18, 4) @map("current_price_list_1")
  currentPriceList2     Decimal?  @db.Decimal(18, 4) @map("current_price_list_2")
  currentPriceList3     Decimal?  @db.Decimal(18, 4) @map("current_price_list_3")
  currentPriceList4     Decimal?  @db.Decimal(18, 4) @map("current_price_list_4")
  currentPriceList5     Decimal?  @db.Decimal(18, 4) @map("current_price_list_5")
  currentPriceList6     Decimal?  @db.Decimal(18, 4) @map("current_price_list_6")
  currentPriceList7     Decimal?  @db.Decimal(18, 4) @map("current_price_list_7")
  currentPriceList8     Decimal?  @db.Decimal(18, 4) @map("current_price_list_8")
  currentPriceList9     Decimal?  @db.Decimal(18, 4) @map("current_price_list_9")
  currentPriceList10    Decimal?  @db.Decimal(18, 4) @map("current_price_list_10")

  currentMarginList1    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_1")
  currentMarginList2    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_2")
  currentMarginList3    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_3")
  currentMarginList4    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_4")
  currentMarginList5    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_5")
  currentMarginList6    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_6")
  currentMarginList7    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_7")
  currentMarginList8    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_8")
  currentMarginList9    Decimal?  @db.Decimal(18, 4) @map("current_margin_list_9")
  currentMarginList10   Decimal?  @db.Decimal(18, 4) @map("current_margin_list_10")

  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([productCode])
  @@index([lastChangeDate])
  @@map("product_price_stats")
}

// ==================== REPORT EXCLUSIONS ====================

enum ExclusionType {
  PRODUCT_CODE      // Ürün kodu
  CUSTOMER_CODE     // Cari kodu
  CUSTOMER_NAME     // Cari adı (kısmi eşleşme)
  PRODUCT_NAME      // Ürün adı (kısmi eşleşme)
  SECTOR_CODE       // Sektör kodu
}

// Raporlardan hariç tutulacak ürün/müşteriler
model ReportExclusion {
  id                    String          @id @default(uuid())

  type                  ExclusionType
  value                 String          // Hariç tutulacak değer (örn: "120.01.001" veya "ÇAMSAN")
  description           String?         // Açıklama (opsiyonel)

  active                Boolean         @default(true)
  createdBy             String?         // Kim oluşturdu (User ID)

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([type])
  @@index([active])
  @@index([value])
}

// ==================== TASKS ====================

model Task {
  id              String        @id @default(uuid())
  title           String
  description     String?
  type            TaskType
  status          TaskStatus    @default(NEW)
  priority        TaskPriority  @default(NONE)
  dueDate         DateTime?

  createdById     String
  createdBy       User          @relation("TaskCreator", fields: [createdById], references: [id])
  assignedToId    String?
  assignedTo      User?         @relation("TaskAssignee", fields: [assignedToId], references: [id])
  customerId      String?
  customer        User?         @relation("TaskCustomer", fields: [customerId], references: [id])
  sectorCode      String?

  templateId      String?
  template        TaskTemplate? @relation(fields: [templateId], references: [id])

  lastActivityAt  DateTime      @default(now())
  completedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  comments        TaskComment[]
  attachments     TaskAttachment[]
  links           TaskLink[]
  statusHistory   TaskStatusHistory[]

  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([assignedToId])
  @@index([createdById])
  @@index([customerId])
  @@index([sectorCode])
  @@index([lastActivityAt])
}

model TaskComment {
  id          String          @id @default(uuid())
  taskId      String
  task        Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId    String
  author      User            @relation("TaskCommentAuthor", fields: [authorId], references: [id])
  body        String
  visibility  TaskVisibility  @default(PUBLIC)
  createdAt   DateTime        @default(now())

  @@index([taskId])
  @@index([authorId])
}

model TaskAttachment {
  id            String          @id @default(uuid())
  taskId        String
  task          Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedById  String
  uploadedBy    User            @relation("TaskAttachmentUploader", fields: [uploadedById], references: [id])
  fileName      String
  originalName  String
  mimeType      String
  size          Int
  url           String
  visibility    TaskVisibility  @default(PUBLIC)
  createdAt     DateTime        @default(now())

  @@index([taskId])
  @@index([uploadedById])
}

model TaskLink {
  id            String        @id @default(uuid())
  taskId        String
  task          Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  type          TaskLinkType
  label         String?
  referenceId   String?
  referenceCode String?
  referenceUrl  String?
  createdAt     DateTime      @default(now())

  @@index([taskId])
  @@index([type])
}

model TaskStatusHistory {
  id            String       @id @default(uuid())
  taskId        String
  task          Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fromStatus    TaskStatus?
  toStatus      TaskStatus
  changedById   String?
  changedBy     User?        @relation("TaskStatusChanger", fields: [changedById], references: [id])
  createdAt     DateTime     @default(now())

  @@index([taskId])
  @@index([changedById])
}

model TaskTemplate {
  id            String        @id @default(uuid())
  title         String
  description   String?
  type          TaskType
  priority      TaskPriority  @default(NONE)
  defaultStatus TaskStatus    @default(NEW)
  checklist     Json?
  isActive      Boolean       @default(true)

  createdById   String?
  createdBy     User?         @relation("TaskTemplateCreator", fields: [createdById], references: [id])
  tasks         Task[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  body      String?
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}







